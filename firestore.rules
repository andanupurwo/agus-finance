rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: Check if user is member of family
    function isFamilyMember(familyId) {
      return exists(/databases/$(database)/documents/families/$(familyId)) &&
             request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.members;
    }
    
    // Helper function: Get member role
    function getMemberRole(familyId) {
      return get(/databases/$(database)/documents/families/$(familyId)).data.members[request.auth.uid].role;
    }
    
    // Helper function: Check if member can edit
    function canEditFamily(familyId) {
      let role = getMemberRole(familyId);
      return role == 'superadmin' || role == 'admin';
    }

    // Users collection
    match /users/{userId} {
      allow read: if request.auth.uid == userId ||
                     isFamilyMember(request.auth.uid in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId);
      allow write: if request.auth.uid == userId;
    }

    // Families collection
    match /families/{familyId} {
      allow read: if isFamilyMember(familyId);
      allow write: if isFamilyMember(familyId) && canEditFamily(familyId);
      allow delete: if isFamilyMember(familyId) && getMemberRole(familyId) == 'superadmin';
    }

    // Wallets - family-based shared access
    match /wallets/{walletId} {
      allow read: if isFamilyMember(resource.data.familyId);
      allow create: if request.auth != null && isFamilyMember(request.resource.data.familyId) &&
                       canEditFamily(request.resource.data.familyId);
      allow write: if isFamilyMember(resource.data.familyId) && canEditFamily(resource.data.familyId);
      allow delete: if isFamilyMember(resource.data.familyId) && getMemberRole(resource.data.familyId) == 'superadmin';
    }

    // Budgets - family-based shared access
    match /budgets/{budgetId} {
      allow read: if isFamilyMember(resource.data.familyId);
      allow create: if request.auth != null && isFamilyMember(request.resource.data.familyId) &&
                       canEditFamily(request.resource.data.familyId);
      allow write: if isFamilyMember(resource.data.familyId) && canEditFamily(resource.data.familyId);
      allow delete: if isFamilyMember(resource.data.familyId) && getMemberRole(resource.data.familyId) == 'superadmin';
    }

    // Transactions - family-based shared access
    match /transactions/{transactionId} {
      allow read: if isFamilyMember(resource.data.familyId);
      allow create: if request.auth != null && isFamilyMember(request.resource.data.familyId);
      allow write: if isFamilyMember(resource.data.familyId) && 
                      (getMemberRole(resource.data.familyId) in ['superadmin', 'admin'] ||
                       request.auth.uid == resource.data.createdBy);
      allow delete: if isFamilyMember(resource.data.familyId) && getMemberRole(resource.data.familyId) == 'superadmin';
    }
  }
}
